# Dockerfile for a complete C++/gRPC Development Environment for CLion
# with Redis, PostgreSQL, curl, wget, and git.

# 使用 Ubuntu 24.04 作为基础镜像
FROM ubuntu:24.04

# --- 1. 设置环境变量 ---
# 防止 apt-get 在安装时进行交互式提问
ENV DEBIAN_FRONTEND=noninteractive
# gRPC 版本
ARG GRPC_VERSION=v1.64.0
# 自定义安装目录，方便管理
ENV MY_INSTALL_DIR=/usr/local/grpc_install
# 将 gRPC 的可执行文件和库文件路径添加到系统环境中
ENV PATH="${MY_INSTALL_DIR}/bin:${PATH}"
ENV LD_LIBRARY_PATH="${MY_INSTALL_DIR}/lib:${MY_INSTALL_DIR}/lib64:${LD_LIBRARY_PATH:-}"

# --- 2. 安装所有开发和连接所需的工具 ---
# 包括：编译器、构建工具、调试器、git、ssh 服务、网络工具
# 以及 Redis 和 PostgreSQL 的客户端开发库
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    autoconf \
    libtool \
    pkg-config \
    cmake \
    git \
    curl \
    wget \
    ca-certificates \
    gdb \
    openssh-server \
    # 添加 Redis C 客户端开发库
    libhiredis-dev \
    # 添加 PostgreSQL C 客户端开发库
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# --- 3. 编译并安装 gRPC ---
# 克隆指定版本的 gRPC 源码
RUN git clone --recurse-submodules -b ${GRPC_VERSION} --depth 1 --shallow-submodules https://github.com/grpc/grpc /grpc_source
# 进入源码目录并创建构建目录
WORKDIR /grpc_source
RUN mkdir -p cmake/build
WORKDIR /grpc_source/cmake/build
# 运行 cmake 配置构建选项
RUN cmake -DgRPC_INSTALL=ON \
          -DgRPC_BUILD_TESTS=OFF \
          -DCMAKE_CXX_STANDARD=17 \
          -DCMAKE_INSTALL_PREFIX=${MY_INSTALL_DIR} ../..
# 使用所有可用的 CPU核心进行编译
RUN make -j$(nproc)
# 安装到我们指定的环境变量目录 ${MY_INSTALL_DIR}
RUN make install
# 清理源码，减小镜像体积
RUN rm -rf /grpc_source

# --- 4. 配置 SSH 服务 ---
# 创建 sshd 运行目录
RUN mkdir /var/run/sshd
# 生成 SSH 主机密钥
RUN ssh-keygen -A
# 允许 root 用户通过密码登录 (仅限开发环境)
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
# 设置 root 用户的密码为 "1234"
RUN echo 'root:1234' | chpasswd

# --- 5. 暴露端口并设置启动命令 ---
# 暴露 SSH 服务的 22 端口
EXPOSE 22

# 设置容器的默认启动命令为启动 sshd 服务
# -D 选项让 sshd 在前台运行，这对于 Docker 是必需的
CMD ["/usr/sbin/sshd", "-D"]